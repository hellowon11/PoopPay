<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoopPay åç«¯éªŒè¯å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #4CAF50;
            background: #f9f9f9;
        }
        .section.error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .section.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: monospace;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-item {
            margin: 5px 0;
            padding: 5px;
        }
        .log-item.success { color: #28a745; }
        .log-item.error { color: #dc3545; }
        .log-item.info { color: #17a2b8; }
        .log-item.warning { color: #ffc107; }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 5px;
        }
        .checklist li.checked {
            background: #d4edda;
            color: #155724;
        }
        .checklist li.checked::before {
            content: "âœ“ ";
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” PoopPay åç«¯éªŒè¯å·¥å…·</h1>
        <p>ä½¿ç”¨æ­¤å·¥å…·éªŒè¯ Supabase åç«¯æ˜¯å¦æ­£ç¡®é…ç½®ï¼Œå¹¶æµ‹è¯•æ•°æ®è¯»å†™åŠŸèƒ½ã€‚</p>
        
        <div class="section">
            <h3>æ­¥éª¤ 1: é…ç½® Supabase è¿æ¥</h3>
            <div class="input-group">
                <label>Supabase Project URL:</label>
                <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
            </div>
            <div class="input-group">
                <label>Supabase Anon Key:</label>
                <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>
        </div>

        <div class="section">
            <h3>æ­¥éª¤ 2: éªŒè¯æ£€æŸ¥æ¸…å•</h3>
            <ul class="checklist" id="checklist">
                <li id="check-env">ç¯å¢ƒå˜é‡é…ç½®</li>
                <li id="check-connection">Supabase è¿æ¥</li>
                <li id="check-tables">æ•°æ®åº“è¡¨å­˜åœ¨</li>
                <li id="check-users">ç”¨æˆ·è¡¨è¯»å†™</li>
                <li id="check-sessions">ä¼šè¯è¡¨è¯»å†™</li>
                <li id="check-settings">è®¾ç½®è¡¨è¯»å†™</li>
                <li id="check-scores">æ¸¸æˆåˆ†æ•°è¡¨è¯»å†™</li>
            </ul>
        </div>

        <div class="input-group">
            <label>
                <input type="checkbox" id="keepTestData" style="width: auto; margin-right: 8px;">
                ä¿ç•™æµ‹è¯•æ•°æ®ï¼ˆä¸è‡ªåŠ¨æ¸…ç†ï¼‰
            </label>
        </div>
        
        <button onclick="runAllTests()">ğŸš€ è¿è¡Œå®Œæ•´éªŒè¯</button>
        <button onclick="testConnection()">1. æµ‹è¯•è¿æ¥</button>
        <button onclick="testTables()">2. æ£€æŸ¥è¡¨ç»“æ„</button>
        <button onclick="testReadWrite()">3. æµ‹è¯•è¯»å†™</button>
        <button onclick="createPermanentTestData()">4. åˆ›å»ºæ°¸ä¹…æµ‹è¯•æ•°æ®</button>
        
        <div id="status" class="status"></div>
        <div id="log" class="log"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabaseClient = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const item = document.createElement('div');
            item.className = `log-item ${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(item);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }
        
        function checkItem(id, checked) {
            const item = document.getElementById(id);
            if (checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
        }
        
        function initClient() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                showStatus('è¯·å…ˆå¡«å†™ Supabase URL å’Œ Key', 'error');
                return false;
            }
            
            try {
                supabaseClient = window.supabase.createClient(url, key);
                log('Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–', 'success');
                return true;
            } catch (error) {
                log(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testConnection() {
            if (!initClient()) return;
            
            log('æµ‹è¯• Supabase è¿æ¥...', 'info');
            checkItem('check-connection', false);
            
            try {
                // å°è¯•æŸ¥è¯¢ä¸€ä¸ªç®€å•çš„è¡¨
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    showStatus('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                    return false;
                }
                
                log('âœ“ Supabase è¿æ¥æˆåŠŸï¼', 'success');
                checkItem('check-connection', true);
                showStatus('è¿æ¥æˆåŠŸï¼', 'success');
                return true;
            } catch (error) {
                log(`è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                showStatus('è¿æ¥é”™è¯¯: ' + error.message, 'error');
                return false;
            }
        }
        
        async function testTables() {
            if (!supabaseClient) {
                if (!initClient()) return;
            }
            
            log('æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„...', 'info');
            checkItem('check-tables', false);
            
            const tables = ['users', 'sessions', 'user_settings', 'game_scores'];
            const results = {};
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabaseClient
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        log(`âœ— è¡¨ ${table} ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: ${error.message}`, 'error');
                        results[table] = false;
                    } else {
                        log(`âœ“ è¡¨ ${table} å­˜åœ¨ä¸”å¯è®¿é—®`, 'success');
                        results[table] = true;
                    }
                } catch (error) {
                    log(`âœ— è¡¨ ${table} æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                    results[table] = false;
                }
            }
            
            const allExist = Object.values(results).every(r => r);
            checkItem('check-tables', allExist);
            
            if (allExist) {
                showStatus('æ‰€æœ‰è¡¨éƒ½å­˜åœ¨ï¼', 'success');
            } else {
                showStatus('éƒ¨åˆ†è¡¨ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è®¾ç½®', 'error');
            }
            
            return allExist;
        }
        
        async function testReadWrite() {
            if (!supabaseClient) {
                if (!initClient()) return;
            }
            
            log('æµ‹è¯•æ•°æ®è¯»å†™åŠŸèƒ½...', 'info');
            
            // æµ‹è¯•ç”¨æˆ·è¡¨
            checkItem('check-users', false);
            try {
                const testUserId = 'TEST' + Date.now().toString().slice(-6);
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('users')
                    .insert([{ id: testUserId, username: 'TestUser' }])
                    .select();
                
                if (insertError) {
                    log(`âœ— ç”¨æˆ·è¡¨å†™å…¥å¤±è´¥: ${insertError.message}`, 'error');
                } else {
                    log(`âœ“ ç”¨æˆ·è¡¨å†™å…¥æˆåŠŸ (ID: ${testUserId})`, 'success');
                    
                    // æµ‹è¯•è¯»å–
                    const { data: readData, error: readError } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', testUserId)
                        .single();
                    
                    if (readError) {
                        log(`âœ— ç”¨æˆ·è¡¨è¯»å–å¤±è´¥: ${readError.message}`, 'error');
                    } else {
                        log(`âœ“ ç”¨æˆ·è¡¨è¯»å–æˆåŠŸ`, 'success');
                        checkItem('check-users', true);
                        
                        // æ¸…ç†æµ‹è¯•æ•°æ®ï¼ˆå¦‚æœæœªå‹¾é€‰ä¿ç•™ï¼‰
                        const keepData = document.getElementById('keepTestData').checked;
                        if (!keepData) {
                            await supabaseClient.from('users').delete().eq('id', testUserId);
                            log(`âœ“ æµ‹è¯•æ•°æ®å·²æ¸…ç†`, 'info');
                        } else {
                            log(`âœ“ æµ‹è¯•æ•°æ®å·²ä¿ç•™ (ID: ${testUserId})`, 'info');
                        }
                    }
                }
            } catch (error) {
                log(`âœ— ç”¨æˆ·è¡¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            // æµ‹è¯•ä¼šè¯è¡¨
            checkItem('check-sessions', false);
            try {
                const testUserId = 'TEST' + Date.now().toString().slice(-6);
                // å…ˆåˆ›å»ºæµ‹è¯•ç”¨æˆ·
                await supabaseClient.from('users').insert([{ id: testUserId, username: 'TestUser' }]);
                
                const testSession = {
                    user_id: testUserId,
                    startTime: Date.now() - 60000,
                    endTime: Date.now(),
                    durationSeconds: 60,
                    earnings: 1.50
                };
                
                const { error: insertError } = await supabaseClient
                    .from('sessions')
                    .insert([testSession]);
                
                if (insertError) {
                    log(`âœ— ä¼šè¯è¡¨å†™å…¥å¤±è´¥: ${insertError.message}`, 'error');
                } else {
                    log(`âœ“ ä¼šè¯è¡¨å†™å…¥æˆåŠŸ`, 'success');
                    
                    const { data, error: readError } = await supabaseClient
                        .from('sessions')
                        .select('*')
                        .eq('user_id', testUserId);
                    
                    if (readError) {
                        log(`âœ— ä¼šè¯è¡¨è¯»å–å¤±è´¥: ${readError.message}`, 'error');
                    } else {
                        log(`âœ“ ä¼šè¯è¡¨è¯»å–æˆåŠŸ (æ‰¾åˆ° ${data.length} æ¡è®°å½•)`, 'success');
                        checkItem('check-sessions', true);
                        
                        // æ¸…ç†æµ‹è¯•æ•°æ®ï¼ˆå¦‚æœæœªå‹¾é€‰ä¿ç•™ï¼‰
                        const keepData = document.getElementById('keepTestData').checked;
                        if (!keepData) {
                            await supabaseClient.from('sessions').delete().eq('user_id', testUserId);
                            await supabaseClient.from('users').delete().eq('id', testUserId);
                        } else {
                            log(`âœ“ æµ‹è¯•æ•°æ®å·²ä¿ç•™ (ç”¨æˆ·ID: ${testUserId})`, 'info');
                        }
                    }
                }
            } catch (error) {
                log(`âœ— ä¼šè¯è¡¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            // æµ‹è¯•è®¾ç½®è¡¨
            checkItem('check-settings', false);
            try {
                const testUserId = 'TEST' + Date.now().toString().slice(-6);
                await supabaseClient.from('users').insert([{ id: testUserId, username: 'TestUser' }]);
                
                const testSettings = {
                    user_id: testUserId,
                    monthly_salary: 5000,
                    currency_symbol: 'RM',
                    working_days_per_month: 21.75,
                    hours_per_day: 8
                };
                
                const { error: insertError } = await supabaseClient
                    .from('user_settings')
                    .upsert([testSettings], { onConflict: 'user_id' });
                
                if (insertError) {
                    log(`âœ— è®¾ç½®è¡¨å†™å…¥å¤±è´¥: ${insertError.message}`, 'error');
                } else {
                    log(`âœ“ è®¾ç½®è¡¨å†™å…¥æˆåŠŸ`, 'success');
                    
                    const { data, error: readError } = await supabaseClient
                        .from('user_settings')
                        .select('*')
                        .eq('user_id', testUserId)
                        .single();
                    
                    if (readError) {
                        log(`âœ— è®¾ç½®è¡¨è¯»å–å¤±è´¥: ${readError.message}`, 'error');
                    } else {
                        log(`âœ“ è®¾ç½®è¡¨è¯»å–æˆåŠŸ`, 'success');
                        checkItem('check-settings', true);
                        
                        // æ¸…ç†æµ‹è¯•æ•°æ®ï¼ˆå¦‚æœæœªå‹¾é€‰ä¿ç•™ï¼‰
                        const keepData = document.getElementById('keepTestData').checked;
                        if (!keepData) {
                            await supabaseClient.from('user_settings').delete().eq('user_id', testUserId);
                            await supabaseClient.from('users').delete().eq('id', testUserId);
                        } else {
                            log(`âœ“ æµ‹è¯•æ•°æ®å·²ä¿ç•™ (ç”¨æˆ·ID: ${testUserId})`, 'info');
                        }
                    }
                }
            } catch (error) {
                log(`âœ— è®¾ç½®è¡¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            // æµ‹è¯•æ¸¸æˆåˆ†æ•°è¡¨
            checkItem('check-scores', false);
            try {
                const testUserId = 'TEST' + Date.now().toString().slice(-6);
                await supabaseClient.from('users').insert([{ id: testUserId, username: 'TestUser' }]);
                
                const testScore = {
                    user_id: testUserId,
                    game_name: 'test_game',
                    score: 100
                };
                
                const { error: insertError } = await supabaseClient
                    .from('game_scores')
                    .insert([testScore]);
                
                if (insertError) {
                    log(`âœ— æ¸¸æˆåˆ†æ•°è¡¨å†™å…¥å¤±è´¥: ${insertError.message}`, 'error');
                } else {
                    log(`âœ“ æ¸¸æˆåˆ†æ•°è¡¨å†™å…¥æˆåŠŸ`, 'success');
                    
                    const { data, error: readError } = await supabaseClient
                        .from('game_scores')
                        .select('*')
                        .eq('user_id', testUserId);
                    
                    if (readError) {
                        log(`âœ— æ¸¸æˆåˆ†æ•°è¡¨è¯»å–å¤±è´¥: ${readError.message}`, 'error');
                    } else {
                        log(`âœ“ æ¸¸æˆåˆ†æ•°è¡¨è¯»å–æˆåŠŸ`, 'success');
                        checkItem('check-scores', true);
                        
                        // æ¸…ç†æµ‹è¯•æ•°æ®ï¼ˆå¦‚æœæœªå‹¾é€‰ä¿ç•™ï¼‰
                        const keepData = document.getElementById('keepTestData').checked;
                        if (!keepData) {
                            await supabaseClient.from('game_scores').delete().eq('user_id', testUserId);
                            await supabaseClient.from('users').delete().eq('id', testUserId);
                        } else {
                            log(`âœ“ æµ‹è¯•æ•°æ®å·²ä¿ç•™ (ç”¨æˆ·ID: ${testUserId})`, 'info');
                        }
                    }
                }
            } catch (error) {
                log(`âœ— æ¸¸æˆåˆ†æ•°è¡¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
            
            showStatus('è¯»å†™æµ‹è¯•å®Œæˆï¼', 'info');
        }
        
        async function runAllTests() {
            log('å¼€å§‹å®Œæ•´éªŒè¯æµç¨‹...', 'info');
            showStatus('æ­£åœ¨éªŒè¯...', 'info');
            
            // æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼ˆæ¨¡æ‹Ÿï¼‰
            checkItem('check-env', true);
            log('âœ“ ç¯å¢ƒå˜é‡é…ç½®æ£€æŸ¥ï¼ˆè¯·åœ¨åº”ç”¨ä¸­ç¡®è®¤ .env æ–‡ä»¶ï¼‰', 'success');
            
            // æµ‹è¯•è¿æ¥
            const connected = await testConnection();
            if (!connected) {
                showStatus('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Supabase URL å’Œ Key', 'error');
                return;
            }
            
            // ç­‰å¾…ä¸€ä¸‹
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æµ‹è¯•è¡¨ç»“æ„
            const tablesOk = await testTables();
            if (!tablesOk) {
                showStatus('è¡¨ç»“æ„æ£€æŸ¥å¤±è´¥ï¼Œè¯·è¿è¡Œ SQL è„šæœ¬åˆ›å»ºè¡¨', 'error');
                return;
            }
            
            // ç­‰å¾…ä¸€ä¸‹
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æµ‹è¯•è¯»å†™
            await testReadWrite();
            
            showStatus('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼å¦‚æœæ‰€æœ‰é¡¹ç›®éƒ½æ˜¾ç¤º âœ“ï¼Œè¯´æ˜åç«¯é…ç½®æ­£ç¡®ã€‚', 'success');
        }
        
        async function createPermanentTestData() {
            if (!initClient()) return;
            
            log('åˆ›å»ºæ°¸ä¹…æµ‹è¯•æ•°æ®...', 'info');
            
            try {
                const testUserId = 'DEMO' + Date.now().toString().slice(-6);
                
                // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
                const { error: userError } = await supabaseClient
                    .from('users')
                    .insert([{ id: testUserId, username: 'DemoUser' }]);
                
                if (userError) {
                    log(`âœ— åˆ›å»ºç”¨æˆ·å¤±è´¥: ${userError.message}`, 'error');
                    return;
                }
                log(`âœ“ åˆ›å»ºç”¨æˆ·æˆåŠŸ (ID: ${testUserId})`, 'success');
                
                // åˆ›å»ºæµ‹è¯•ä¼šè¯
                const testSession = {
                    user_id: testUserId,
                    startTime: Date.now() - 300000,
                    endTime: Date.now() - 240000,
                    durationSeconds: 60,
                    earnings: 2.50,
                    note: 'Test session from verification tool',
                    poop_type: 4,
                    poop_color: 'brown',
                    poop_volume: 'Normal'
                };
                
                const { error: sessionError } = await supabaseClient
                    .from('sessions')
                    .insert([testSession]);
                
                if (sessionError) {
                    log(`âœ— åˆ›å»ºä¼šè¯å¤±è´¥: ${sessionError.message}`, 'error');
                } else {
                    log(`âœ“ åˆ›å»ºä¼šè¯æˆåŠŸ`, 'success');
                }
                
                // åˆ›å»ºæµ‹è¯•è®¾ç½®
                const testSettings = {
                    user_id: testUserId,
                    monthly_salary: 5000,
                    currency_symbol: 'RM',
                    working_days_per_month: 21.75,
                    hours_per_day: 8
                };
                
                const { error: settingsError } = await supabaseClient
                    .from('user_settings')
                    .upsert([testSettings], { onConflict: 'user_id' });
                
                if (settingsError) {
                    log(`âœ— åˆ›å»ºè®¾ç½®å¤±è´¥: ${settingsError.message}`, 'error');
                } else {
                    log(`âœ“ åˆ›å»ºè®¾ç½®æˆåŠŸ`, 'success');
                }
                
                // åˆ›å»ºæµ‹è¯•æ¸¸æˆåˆ†æ•°
                const testScore = {
                    user_id: testUserId,
                    game_name: 'snake_turd',
                    score: 500
                };
                
                const { error: scoreError } = await supabaseClient
                    .from('game_scores')
                    .insert([testScore]);
                
                if (scoreError) {
                    log(`âœ— åˆ›å»ºæ¸¸æˆåˆ†æ•°å¤±è´¥: ${scoreError.message}`, 'error');
                } else {
                    log(`âœ“ åˆ›å»ºæ¸¸æˆåˆ†æ•°æˆåŠŸ`, 'success');
                }
                
                showStatus(`âœ… æ°¸ä¹…æµ‹è¯•æ•°æ®å·²åˆ›å»ºï¼ç”¨æˆ·ID: ${testUserId}ï¼Œè¯·åœ¨ Supabase Table Editor ä¸­æŸ¥çœ‹ã€‚`, 'success');
                log(`\nğŸ“‹ æµ‹è¯•æ•°æ®ä¿¡æ¯ï¼š`, 'info');
                log(`   ç”¨æˆ·ID: ${testUserId}`, 'info');
                log(`   ç”¨æˆ·å: DemoUser`, 'info');
                log(`   ä¼šè¯æ•°: 1`, 'info');
                log(`   è®¾ç½®: å·²åˆ›å»º`, 'info');
                log(`   æ¸¸æˆåˆ†æ•°: å·²åˆ›å»º`, 'info');
                
            } catch (error) {
                log(`âœ— åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                showStatus('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
